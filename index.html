<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Simnote - A beautiful journaling app for capturing your thoughts, tracking your moods, and reflecting on your journey." />
    <meta name="theme-color" content="#fcd8ff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Simnote" />
    <title>Simnote</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="img/icon-32.png" />
    <link rel="apple-touch-icon" href="img/icon-192.png" />
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/base.css" />
    <!-- Google Font for main menu logo -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <!-- sql.js for SQLite support (local for offline support) -->
    <script src="/js/lib/sql-wasm.js"></script>
  </head>
  <body>
    <div class="utility-buttons" aria-label="Quick Controls">
      <!-- Manual Button -->
      <button id="manual-btn" class="manual-btn" aria-label="Manual">
        <span class="manual-book" aria-hidden="true">
          <span class="manual-book__pg-shadow"></span>
          <span class="manual-book__pg"></span>
          <span class="manual-book__pg manual-book__pg--2"></span>
          <span class="manual-book__pg manual-book__pg--3"></span>
          <span class="manual-book__pg manual-book__pg--4"></span>
          <span class="manual-book__pg manual-book__pg--5"></span>
        </span>
      </button>
      <!-- Theme Settings Button -->
      <button id="theme-settings-btn" class="theme-settings-btn" aria-label="Settings">
        <span class="settings-lines" aria-hidden="true">
          <span></span>
          <span></span>
          <span></span>
        </span>
      </button>
    </div>

    <!-- Manual Popup (hidden by default) -->
    <div id="manual-popup" class="manual-popup">
      <h3>Simnote Manual</h3>
      <p>
        Simnote is your calm journaling space. Notes save as you type, so you can focus on writing.
      </p>
      <ul>
        <li>Start a new entry from Journal, or open past entries from Entries.</li>
        <li>Everything autosaves while you type. Press Esc to return to the main menu.</li>
        <li>Add moods, tags, and templates to organize your thoughts.</li>
        <li>Customize themes, fonts, and preferences in Settings.</li>
      </ul>
      <p>Want a refresher? Run the quick tour anytime.</p>
      <button id="manual-tour-btn" class="nav-icon-btn" title="Start Tour">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <path d="M8 5l11 7-11 7z"></path>
        </svg>
        <span class="icon-label">Start Tour</span>
      </button>
      <button id="manual-close-btn" class="nav-icon-btn" title="Close">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        <span class="icon-label">Close</span>
      </button>
    </div>

    <!-- Theme Settings Popup (hidden by default) -->
    <div id="theme-settings-popup" class="theme-settings-popup">
      <div class="settings-section">
        <h4 style="margin:0 0 10px 0;">Theme</h4>
        <nav class="theme-dock" id="theme-selector">
          <button class="theme-block" data-value="plain-dark" title="Dark" style="--theme-color: #888888;">
            <span class="theme-block__item"></span>
          </button>
          <button class="theme-block" data-value="dracula" title="Dracula" style="--theme-color: #bd93f9;">
            <span class="theme-block__item"></span>
          </button>
          <button class="theme-block" data-value="monokai" title="Monokai" style="--theme-color: #a6e22e;">
            <span class="theme-block__item"></span>
          </button>
        </nav>
      </div>

      <!-- Data & Storage -->
      <div class="settings-section" style="margin-top:20px;">
        <h4 style="margin:0 0 8px 0;">Data & Storage</h4>
        <div class="storage-info-compact">
          <span class="storage-stat-inline"><span id="storage-entries">0</span> entries</span>
          <span class="storage-divider">‚Ä¢</span>
          <span class="storage-stat-inline"><span id="storage-images">0</span> images</span>
          <span class="storage-divider">‚Ä¢</span>
          <span class="storage-stat-inline"><span id="storage-size">0 KB</span></span>
        </div>
        
        <!-- File Storage Location -->
        <div class="storage-location-info" id="storage-location-section">
          <div class="storage-location-header">
            <svg class="storage-location-icon" viewBox="0 0 24 24" width="14" height="14">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span class="storage-location-label">File Storage</span>
            <span class="storage-location-status" id="storage-location-status">‚óè</span>
          </div>
          <div class="storage-location-path" id="storage-location-path" title="Click to open folder">
            ~/Documents/Simnote
          </div>
          <div class="storage-location-hint">
            Your entries are saved as .simnote files for backup & portability
          </div>
        </div>
        
        <div class="storage-actions">
          <button id="export-data-btn" class="nav-icon-btn" title="Export">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span class="icon-label">Export</span>
          </button>
          <button id="import-data-btn" class="nav-icon-btn" title="Import">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span class="icon-label">Import</span>
          </button>
          <button id="clear-data-btn" class="nav-icon-btn danger" title="Clear All">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            <span class="icon-label">Clear</span>
          </button>
        </div>
        <input type="file" id="import-file-input" accept=".json" style="display:none;" />
      </div>

      <!-- Preferences -->
      <div class="settings-section" style="margin-top:20px;">
        <h4 style="margin:0 0 8px 0;">Preferences</h4>
        <div class="settings-option">
          <span class="settings-option-label">Daily mood check-in</span>
          <label class="toggle-switch">
            <input type="checkbox" id="mood-checkin-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span class="settings-option-label">Show entry previews</span>
          <label class="toggle-switch">
            <input type="checkbox" id="preview-toggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <span class="settings-option-label">Compact list view</span>
          <label class="toggle-switch">
            <input type="checkbox" id="compact-view-toggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <!-- Close button -->
      <button id="theme-settings-close-btn" class="nav-icon-btn" title="Close" style="position:absolute;bottom:20px;right:20px;">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        <span class="icon-label">Close</span>
      </button>
    </div>

    <!-- Background Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Main Panel -->
    <div id="main-panel">
      <div class="blur-overlay"></div>
      <div class="center-container">
        <div class="logo-and-heart">
          <div class="simnote-logo">
            <span class="logo-text">Simnote</span>
            <span class="logo-version">v0.1.0</span>
          </div>
        </div>
        <!-- 3D Drawer Navigation -->
        <div class="drawer-nav" id="drawer-nav">
          <div class="chest">
            <div class="chest__panel chest__panel--back"></div>
            <div class="chest__panel chest__panel--top"></div>
            <div class="chest__panel chest__panel--bottom"></div>
            <div class="chest__panel chest__panel--right"></div>
            <div class="chest__panel chest__panel--front">
              <div class="chest__panel chest__panel--front-frame"></div>
            </div>
            <div class="chest__panel chest__panel--left"></div>
            
            <!-- Drawer 1: Journal -->
            <div class="chest__drawer drawer" data-position="1" data-action="journal">
              <button class="drawer-trigger" id="new-entry-btn" title="Journal"></button>
              <span class="drawer-label">Journal</span>
              <div class="drawer__structure">
                <div class="drawer__panel drawer__panel--back">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 20h9"></path>
                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
                  </svg>
                </div>
                <div class="drawer__panel drawer__panel--bottom"></div>
                <div class="drawer__panel drawer__panel--right"></div>
                <div class="drawer__panel drawer__panel--left"></div>
                <div class="drawer__panel drawer__panel--front"></div>
              </div>
            </div>
            
            <!-- Drawer 2: Entries -->
            <div class="chest__drawer drawer" data-position="2" data-action="entries">
              <button class="drawer-trigger" id="load-entry-btn" title="Entries"></button>
              <span class="drawer-label">Entries</span>
              <div class="drawer__structure">
                <div class="drawer__panel drawer__panel--back">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M2 3h7a4 4 0 0 1 4 4v14a3 3 0 0 0-4-3H2z"></path>
                    <path d="M22 3h-7a4 4 0 0 0-4 4v14a3 3 0 0 1 4-3h7z"></path>
                  </svg>
                </div>
                <div class="drawer__panel drawer__panel--bottom"></div>
                <div class="drawer__panel drawer__panel--right"></div>
                <div class="drawer__panel drawer__panel--left"></div>
                <div class="drawer__panel drawer__panel--front"></div>
              </div>
            </div>
            
            <!-- Drawer 3: Moods -->
            <div class="chest__drawer drawer" data-position="3" data-action="moods">
              <button class="drawer-trigger" id="stats-btn" title="Moods"></button>
              <span class="drawer-label">Moods</span>
              <div class="drawer__structure">
                <div class="drawer__panel drawer__panel--back">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                  </svg>
                </div>
                <div class="drawer__panel drawer__panel--bottom"></div>
                <div class="drawer__panel drawer__panel--right"></div>
                <div class="drawer__panel drawer__panel--left"></div>
                <div class="drawer__panel drawer__panel--front"></div>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <!-- Journal Panel -->
    <div id="journal-panel" style="display: none;">
      <div class="entries-pane">
        <div class="entries-header">
          <h2 style="margin:0">Entries</h2>
          <!-- Search (magnifying glass) toggle & input -->
          <button id="search-toggle-btn" class="search-toggle-btn" title="Search">üîç</button>
          <input id="entry-search" class="entry-search collapsed" type="text" placeholder="Search..." />
          <!-- Sort dropdown -->
          <div class="custom-dropdown sort-dropdown" id="sort-dropdown">
            <div class="custom-dropdown-selected" id="sort-selected">Newest</div>
            <ul class="custom-dropdown-list" id="sort-list">
              <li data-value="newest">Newest First</li>
              <li data-value="oldest">Oldest First</li>
              <li data-value="az">A ‚Üí Z</li>
              <li data-value="mood">By Mood</li>
            </ul>
          </div>
          <button id="date-picker-btn" class="calendar-btn" title="Filter by date">üìÖ</button>
          <div id="custom-calendar" class="custom-calendar" style="display:none;"></div>
        </div>
        <div class="entry-list"></div>
        <button class="nav-icon-btn back-to-menu" title="Back to Menu">
          <svg class="nav-icon-svg" viewBox="0 0 24 24">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span class="icon-label">Menu</span>
        </button>
      </div>
    </div>

    <!-- Mood Tracking Panel -->
    <div id="stats-panel" class="custom-panel stats-panel" style="display:none;">
      <div class="stats-header">
        <h2>Mood Tracking</h2>
      </div>
      <div class="stats-content">
        <!-- Streak Section -->
        <div class="stats-section streak-section">
          <div class="stat-card streak-card">
            <div class="stat-icon">üî•</div>
            <div class="stat-value" id="current-streak">0</div>
            <div class="stat-label">Day Streak</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-value" id="longest-streak">0</div>
            <div class="stat-label">Best Streak</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìù</div>
            <div class="stat-value" id="total-entries">0</div>
            <div class="stat-label">Total Entries</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìñ</div>
            <div class="stat-value" id="total-words">0</div>
            <div class="stat-label">Words Written</div>
          </div>
        </div>

        <!-- Calendar Heatmap -->
        <div class="stats-section">
          <h3>Activity Calendar</h3>
          <div class="heatmap-container">
            <div class="heatmap-months" id="heatmap-months"></div>
            <div class="heatmap-grid" id="heatmap-grid"></div>
            <div class="heatmap-legend">
              <span>Less</span>
              <div class="legend-cell" data-level="0"></div>
              <div class="legend-cell" data-level="1"></div>
              <div class="legend-cell" data-level="2"></div>
              <div class="legend-cell" data-level="3"></div>
              <div class="legend-cell" data-level="4"></div>
              <span>More</span>
            </div>
          </div>
        </div>

        <!-- Mood Distribution -->
        <div class="stats-section">
          <h3>Mood Distribution</h3>
          <div class="mood-chart" id="mood-chart"></div>
        </div>

        <!-- Writing Stats -->
        <div class="stats-section">
          <h3>Writing Statistics</h3>
          <div class="writing-stats">
            <div class="writing-stat">
              <span class="stat-name">Average words per entry</span>
              <span class="stat-val" id="avg-words">0</span>
            </div>
            <div class="writing-stat">
              <span class="stat-name">Favorite entries</span>
              <span class="stat-val" id="favorite-count">0</span>
            </div>
            <div class="writing-stat">
              <span class="stat-name">Most used tags</span>
              <span class="stat-val" id="top-tags">-</span>
            </div>
          </div>
        </div>
      </div>
      <button class="nav-icon-btn stats-back-btn" title="Back to Menu">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="icon-label">Menu</span>
      </button>
    </div>

    <!-- Wellness Chat Panel -->
    <div id="chat-panel" class="custom-panel chat-panel" style="display:none;">
      <div class="chat-header">
        <h2 style="margin:0">Serenity</h2>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input-row" id="chat-input-row">
        <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
      </div>
      <!-- New chat bubble button (initial trigger) -->
      <button id="chat-new-btn" class="chat-new-btn" title="New Chat">üí¨</button>
      <button class="nav-icon-btn chat-back-btn" title="Back" style="margin-top:10px;">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="icon-label">Menu</span>
      </button>
    </div>

    <!-- New Entry Panel -->
    <div id="new-entry-panel" class="custom-panel new-entry-panel" style="display: none;">
      <div class="panel-utility">
        <!-- Settings Button (upper right) -->
        <button class="settings-btn" aria-label="Editor Settings">
          <span class="settings-lines" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
      </div>

      <!-- Circular button container -->
      <div class="new-entry-intro">
        <button class="paint-circle-btn">üñãÔ∏è</button>
      </div>

      <!-- Form contents (hidden until expanded) -->
      <div class="new-entry-contents">
        <div class="panel-title">
          <input type="text" class="entry-name" placeholder="Title" />
        </div>
        <div class="entry-meta">
          <span class="mood-badge"></span>
          <span class="date-stamp"></span>
        </div>
        <div class="panel-content">
          <!-- Rich Text Toolbar -->
          <div class="editor-toolbar">
            <button type="button" class="toolbar-btn" data-command="bold" title="Bold (Ctrl+B)"><b>B</b></button>
            <button type="button" class="toolbar-btn" data-command="italic" title="Italic (Ctrl+I)"><i>I</i></button>
            <button type="button" class="toolbar-btn" data-command="underline" title="Underline (Ctrl+U)"><u>U</u></button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h2" title="Heading">H</button>
            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="blockquote" title="Quote">‚Äú</button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">‚Ä¢</button>
            <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">1.</button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn" data-command="createLink" title="Insert Link">üîó</button>
            <button type="button" class="toolbar-btn insert-image-btn" title="Insert Image">üñºÔ∏è</button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn audio-recorder-btn" title="Record Audio">
              <div class="tape-recorder-3d">
                <div class="tape-base">
                  <div class="tape-mini-reel left"></div>
                  <div class="tape-mini-reel right"></div>
                  <div class="tape-mini-window"></div>
                </div>
              </div>
            </button>
          </div>
          <!-- Rich Text Editor -->
          <div class="entry-content rich-editor" contenteditable="true" data-placeholder="Start writing..."></div>
          <input type="file" class="image-upload-input" accept="image/*" style="display:none;" />
        </div>
        <div class="editor-buttons">
          <button class="nav-icon-btn save-btn" title="Save">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            <span class="icon-label">Save</span>
          </button>
          <button class="nav-icon-btn back-btn" title="Back">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span class="icon-label">Menu</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Mood Panel (intermediary before New Entry) -->
    <div id="mood-panel" class="custom-panel mood-panel" style="display:none;">
      <!-- Date / Greeting Header -->
      <div class="date-header" id="mood-date-header">
        <div class="date-bg"></div>
        <div class="greeting" id="greeting-text"></div>
        <div class="current-date" id="current-date"></div>
        <div class="date-row" id="date-strip"></div>
      </div>
      <h2 class="mood-panel-title">How are you feeling right now?</h2>
      <div style="display:flex;flex-direction:column;align-items:center;gap:20px;">
        <div class="mood-input-row">
          <span id="mood-prompt" class="mood-prompt"></span>
          <input id="mood-input" type="text" placeholder="..." class="mood-input" />
        </div>
        <button class="nav-icon-btn mood-next-btn" title="Start Writing">
          <svg class="nav-icon-svg" viewBox="0 0 24 24">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
          </svg>
          <span class="icon-label">Write</span>
        </button>
        <button class="nav-icon-btn back-btn" title="Back">
          <svg class="nav-icon-svg" viewBox="0 0 24 24">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span class="icon-label">Menu</span>
        </button>
      </div>
    </div>

    <!-- Mood Attributes Panel (after mood input, select what's affecting your mood) -->
    <div id="mood-attributes-panel" class="custom-panel" style="display:none;">
      <h2 class="attributes-title">What's making you feel this way?</h2>
      <p class="attributes-subtitle">Tap to select ‚Ä¢ Hold to edit or reorder</p>
      <div class="attributes-grid"></div>
      <div class="attributes-nav">
        <button class="nav-icon-btn attributes-back-btn" title="Back">
          <svg class="nav-icon-svg" viewBox="0 0 24 24">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span class="icon-label">Back</span>
        </button>
        <button class="nav-icon-btn attributes-next-btn" title="Continue">
          <svg class="nav-icon-svg" viewBox="0 0 24 24">
            <path d="M12 20h9"></path>
            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
          </svg>
          <span class="icon-label">Write</span>
        </button>
      </div>
    </div>

    <!-- Template Picker Panel -->
    <div id="template-panel" class="custom-panel template-panel" style="display:none;">
      <h2>Choose a Template</h2>
      <div class="template-grid"></div>
      <button class="nav-icon-btn tpl-back-btn" title="Back" style="position:absolute;">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span class="icon-label">Menu</span>
      </button>
      <div id="template-info"></div>
    </div>

    <!-- Edit Entry Panel -->
    <div id="edit-entry-panel" class="custom-panel edit-entry-panel" style="display: none;">
      <div class="panel-utility">
        <!-- Settings Button (upper right) -->
        <button class="settings-btn" aria-label="Editor Settings">
          <span class="settings-lines" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </button>
      </div>
      <div class="new-entry-contents">
        <div class="panel-title">
          <input type="text" class="entry-name" placeholder="Title" />
        </div>
        <div class="entry-meta">
          <span class="mood-badge"></span>
          <span class="date-stamp"></span>
        </div>
        <div class="panel-content">
          <!-- Rich Text Toolbar -->
          <div class="editor-toolbar">
            <button type="button" class="toolbar-btn" data-command="bold" title="Bold (Ctrl+B)"><b>B</b></button>
            <button type="button" class="toolbar-btn" data-command="italic" title="Italic (Ctrl+I)"><i>I</i></button>
            <button type="button" class="toolbar-btn" data-command="underline" title="Underline (Ctrl+U)"><u>U</u></button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h2" title="Heading">H</button>
            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="blockquote" title="Quote">‚Äú</button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">‚Ä¢</button>
            <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">1.</button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn" data-command="createLink" title="Insert Link">üîó</button>
            <button type="button" class="toolbar-btn insert-image-btn" title="Insert Image">üñºÔ∏è</button>
            <span class="toolbar-divider"></span>
            <button type="button" class="toolbar-btn audio-recorder-btn" title="Record Audio">
              <div class="tape-recorder-3d">
                <div class="tape-base">
                  <div class="tape-mini-reel left"></div>
                  <div class="tape-mini-reel right"></div>
                  <div class="tape-mini-window"></div>
                </div>
              </div>
            </button>
          </div>
          <!-- Rich Text Editor -->
          <div class="entry-content rich-editor" contenteditable="true" data-placeholder="Start writing..."></div>
          <input type="file" class="image-upload-input" accept="image/*" style="display:none;" />
        </div>
        <div class="editor-buttons">
          <button class="nav-icon-btn save-btn" title="Save">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            <span class="icon-label">Save</span>
          </button>
          <button class="nav-icon-btn back-btn" title="Back">
            <svg class="nav-icon-svg" viewBox="0 0 24 24">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
            <span class="icon-label">Menu</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Shared Settings Panel (slides in from the right) -->
    <div id="settings-panel">
      <h3>Settings</h3>
      <button id="settings-close-btn" class="nav-icon-btn" title="Close" style="position:absolute;bottom:20px;right:20px;">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        <span class="icon-label">Close</span>
      </button>
      <div class="settings-group">
        <label for="font-size-slider">Font Size</label>
        <div class="settings-range">
          <input type="range" id="font-size-slider" min="12" max="24" value="16" />
          <span class="range-value" id="font-size-value">16px</span>
        </div>
      </div>

      <div class="settings-group">
        <label for="line-height-slider">Line Height</label>
        <div class="settings-range">
          <input type="range" id="line-height-slider" min="1.2" max="2.2" step="0.05" value="1.6" />
          <span class="range-value" id="line-height-value">1.6</span>
        </div>
      </div>

      <div class="settings-group">
        <label>Font Family</label>
        <div class="custom-dropdown" id="font-dropdown">
          <div class="custom-dropdown-selected" id="font-dropdown-selected">Arial</div>
          <ul class="custom-dropdown-list" id="font-dropdown-list">
            <li data-value="Arial, sans-serif">Arial</li>
            <li data-value="'Times New Roman', serif">Times New Roman</li>
            <li data-value="'Courier New', monospace">Courier New</li>
            <li data-value="'Georgia', serif">Georgia</li>
            <li data-value="'Verdana', sans-serif">Verdana</li>
          </ul>
        </div>
      </div>

      <div class="settings-group">
        <label>Text Width</label>
        <div class="custom-dropdown" id="entry-width-dropdown">
          <div class="custom-dropdown-selected" id="entry-width-selected">Comfortable</div>
          <ul class="custom-dropdown-list" id="entry-width-list">
            <li data-value="720px">Narrow</li>
            <li data-value="1000px">Comfortable</li>
            <li data-value="100%">Full</li>
          </ul>
        </div>
      </div>

      <div class="settings-option">
        <span class="settings-option-label">Show formatting toolbar</span>
        <label class="toggle-switch">
          <input type="checkbox" id="toolbar-toggle" checked />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="settings-option">
        <span class="settings-option-label">Show word count</span>
        <label class="toggle-switch">
          <input type="checkbox" id="word-count-toggle" />
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="settings-option">
        <span class="settings-option-label">Spellcheck</span>
        <label class="toggle-switch">
          <input type="checkbox" id="spellcheck-toggle" checked />
          <span class="toggle-slider"></span>
        </label>
      </div>

    </div>

    <!-- NEW: Export/Import Popup Panel (hidden by default) -->
    <div id="export-import-popup" class="export-import-popup" style="display: none;">
      <button id="export-btn" class="settings-icon-btn" title="Export">
        <svg class="settings-icon-svg" viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <span class="settings-icon-label">Export</span>
      </button>
      <button id="import-btn" class="settings-icon-btn" title="Import">
        <svg class="settings-icon-svg" viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        <span class="settings-icon-label">Import</span>
      </button>
      <button id="export-import-close-btn" class="nav-icon-btn" title="Close">
        <svg class="nav-icon-svg" viewBox="0 0 24 24">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        <span class="icon-label">Close</span>
      </button>
    </div>

    <!-- Custom Popup -->
    <div id="custom-popup" class="custom-popup">Entry saved!</div>

    <!-- JavaScript Modules -->
    <script type="module" src="js/core/main.js"></script>
    <script type="module" src="js/managers/chatManager.js"></script>
    <script type="module" src="js/managers/statsManager.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('SW registered:', registration.scope);
            })
            .catch(error => {
              console.log('SW registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>
